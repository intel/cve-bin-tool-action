# Copyright (C) 2023 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import subprocess
from pathlib import Path

MIRROR = "https://raw.githubusercontent.com/sec-data/mirror-sandbox/main"


class CVE_BIN_TOOL:
    def __init__(self) -> None:
        self.mirror = MIRROR
        self.pubkey = Path(__file__).parent.parent / "assets" / "mirror" / "pub.asc"

    def update_db(self, nvd_api_key):
        command = [
            "cve-bin-tool",
            "--use-mirror",
            self.mirror,
            "--verify",
            str(self.pubkey),
        ]
        if nvd_api_key:
            command.append("--nvd-api-key")
            command.append(nvd_api_key)
        subprocess.run(command)

    def scan(
        self,
        dir,
        formats=[],
        output=None,
        exclude=None,
        sbom_type=None,
        sbom_format="json",
        sbom_output="SBOM.json",
    ):
        command = [
            "cve-bin-tool",
            dir,
            "--detailed",
            "--available-fix",
            "ubuntu-hirsute",
        ]
        if len(formats):
            formats_string = ",".join(formats)
            command.append("--format")
            command.append(formats_string)
        if output:
            command.append("--output-file")
            command.append(output)
        if exclude:
            command.append("--exclude")
            command.append(exclude)
        if sbom_type:
            command.append("--sbom-type")
            command.append(sbom_type)
            command.append("--sbom-format")
            command.append(sbom_format)
            command.append("--sbom-output")
            command.append(sbom_output)
        captured_output = subprocess.run(command, capture_output=True, text=True).stdout
        print(captured_output)
        return self.__extract_available_fix_from_console(captured_output)

    def __extract_available_fix_from_console(self, captured_output):
        fixes = {}
        lines = captured_output.split("\n")
        captured_output = ""
        for line in lines:
            if line.find("INFO") != -1:
                captured_output += "\n"
            captured_output += f'{line.split("debian_cve_tracker.py")[0].strip()} '
        lines = captured_output.split("\n")
        for line in lines:
            if line.find("has available fix in v") == -1:
                continue
            cve_id = (
                line.split("has available fix in v")[0]
                .split("cve_bin_tool")[1]
                .split(":")[1]
                .strip()
            )
            fixed_release = (
                line.split("has available fix in v")[1].split("release")[0].strip()
            )
            fixes[cve_id] = {"fixed_release": fixed_release}
        return fixes
