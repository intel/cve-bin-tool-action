# Copyright (C) 2023 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import subprocess
from pathlib import Path

MIRROR = "https://raw.githubusercontent.com/sec-data/mirror-sandbox/main"


class CVE_BIN_TOOL:
    def __init__(self, nvd_api_key) -> None:
        self.mirror = MIRROR
        self.pubkey = Path(__file__).parent.parent / "assets" / "mirror" / "pub.asc"
        self.nvd_api_key = nvd_api_key

    def update_db(self):
        command = ["cve-bin-tool", "--use-mirror", self.mirror, "--verify", self.pubkey]
        if self.nvd_api_key:
            command.append("--nvd-api-key")
            command.append(self.nvd_api_key)
        subprocess.run(command)

    def scan(self, dir, formats=[], output=None, exclude=None):
        command = ["cve-bin-tool", dir, "--detailed"]
        if len(formats):
            formats_string = ",".join(formats)
            command.append("--format")
            command.append(formats_string)
        if output:
            command.append("--output-file")
            command.append(output)
        if exclude:
            command.append("--exclude")
            command.append(exclude)
        subprocess.run(command)
