import glob
import json
from pathlib import Path

import yaml


def sbom_finder(directory):
    directory = Path(directory).absolute()
    sboms = []
    for file in glob.iglob(str(directory / "**/**"), recursive=True):
        if file.endswith(".spdx"):
            with open(file) as fd:
                data = fd.read()
                if data.find("SPDXVersion: SPDX-2.2") != -1:
                    sboms.append({"file": file, "type": "spdx"})
        elif (
            file.endswith(".spdx.rdf")
            or file.endswith(".spdx.xml")
            or file.endswith(".spdx.rdf.xml")
        ):
            with open(file) as fd:
                data = fd.read()
                if (
                    data.find("<spdx:specVersion>SPDX-2.2</spdx:specVersion>") != -1
                    or data.find("<spdxVersion>SPDX-2.2</spdxVersion>") != -1
                ):
                    sboms.append({"file": file, "type": "spdx"})
        elif file.endswith(".spdx.json"):
            with open(file) as fd:
                try:
                    json_data = json.load(fd)
                except Exception:
                    json_data = {}
                if (
                    "spdxVersion" in json_data
                    and json_data["spdxVersion"] == "SPDX-2.2"
                ):
                    sboms.append({"file": file, "type": "spdx"})
        elif file.endswith(".spdx.yaml") or file.endswith(".spdx.yml"):
            with open(file) as fd:
                try:
                    yaml_data = yaml.safe_load(fd)
                except Exception:
                    yaml_data = {}
                if (
                    "spdxVersion" in yaml_data
                    and yaml_data["spdxVersion"] == "SPDX-2.2"
                ):
                    sboms.append({"file": file, "type": "spdx"})
        elif file.endswith(".json"):
            with open(file) as fd:
                try:
                    json_data = json.load(fd)
                except Exception:
                    json_data = {}
                if (
                    "bomFormat" in json_data
                    and "specVersion" in json_data
                    and json_data["bomFormat"] == "CycloneDX"
                    and json_data["specVersion"] == "1.3"
                ):
                    sboms.append({"file": file, "type": "cyclonedx"})
        elif file.endswith(".xml"):
            with open(file) as fd:
                data = fd.read()
                if data.find("cyclonedx.org/schema/bom/1.3") != -1:
                    sboms.append({"file": file, "type": "cyclonedx"})
                elif data.find("standards.iso.org/iso/19770/-2/2015/schema.xsd") != -1:
                    sboms.append({"file": file, "type": "swid"})
    return sboms


def compare_dict_list(test_data, real_data):
    for test_data_item in test_data:
        match = False
        for real_data_item in real_data:
            if real_data_item.items() >= test_data_item.items():
                match = True
                break
        if not match:
            return False
    return True
