import argparse

from cve_bin_tool import CVE_BIN_TOOL
from generate_sarif import GenerateSarif

parser = argparse.ArgumentParser(
    prog="scanner",
    description="CVE Binary Tool GitHub Action Scanner",
)

parser.add_argument("--repo", help="GitHub project repository name", required=True)
parser.add_argument("--run-id", help="GitHub workflow run id", required=True)
parser.add_argument("--sarif-output", help="Sarif output filename", required=True)
parser.add_argument(
    "--html-pdf-output",
    help="HTML/PDF output filename (without extension)",
    required=True,
)
parser.add_argument(
    "--nvd-api-key", help="NVD API key for downloading CVE DB", required=False
)

args = parser.parse_args()

cve_bin_tool = CVE_BIN_TOOL(args.nvd_api_key)
cve_bin_tool.update_db()

cve_bin_tool.scan(".", formats=["html", "pdf", "json"], output=args.html_pdf_output)

gen_sarif = GenerateSarif(
    repository=args.repo,
    action_run_id=args.run_id,
    output_file=args.sarif_output,
    json_file_path=f"{args.html_pdf_output}.json",
)
gen_sarif.write_file()
